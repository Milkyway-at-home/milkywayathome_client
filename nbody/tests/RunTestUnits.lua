
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
local testSeed = testSeeds[math.random(1, #testSeeds)]
--local testSeed = testSeeds[5]

refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 1610.9032342542482,
         ["886885833"] = 762.3338204182862,
         ["715144259"] = 1605.0571179802728,
         ["430281807"] = 1143.0883374067034,
         ["543966758"] = 4914.181726277503
      },

      ["1024"] = {
         ["670828913"] = 3610.1073018803777,
         ["886885833"] = 3938.6242328641524,
         ["715144259"] = 3619.0525451691637,
         ["430281807"] = 3665.31146271313,
         ["543966758"] = 3847.393830731902
      },

      ["10000"] = {
         ["670828913"] = 4396.483935817857,
         ["886885833"] = 4313.109053453902,
         ["715144259"] = 4364.773544219497,
         ["430281807"] = 4290.676644357536,
         ["543966758"] = 4343.697645960616
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 4930.961971819416,
         ["886885833"] = 4930.704671656242,
         ["715144259"] = 4908.852812464732,
         ["430281807"] = 4934.2920912707505,
         ["543966758"] = 4899.92677049127
      },

      ["1024"] = {
         ["670828913"] = 4914.702523849116,
         ["886885833"] = 4918.9653690735295,
         ["715144259"] = 4911.795131500262,
         ["430281807"] = 4903.753858408951,
         ["543966758"] = 4911.276425924644
      },

      ["10000"] = {
         ["670828913"] = 4929.585472970283,
         ["886885833"] = 4880.375705726649,
         ["715144259"] = 4916.971995449371,
         ["430281807"] = 4903.358679700319,
         ["543966758"] = 4878.289307370997
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 4919.993124636791,
         ["886885833"] = 4928.962640442522,
         ["715144259"] = 4932.244318312345,
         ["430281807"] = 4920.974915897664,
         ["543966758"] = 4926.468925399597
      },

      ["1024"] = {
         ["670828913"] = 4903.331287391368,
         ["886885833"] = 4906.396832849646,
         ["715144259"] = 4918.273106876136,
         ["430281807"] = 4908.513657189011,
         ["543966758"] = 4924.238107475147
      },

      ["10000"] = {
         ["670828913"] = 4926.66310810938,
         ["886885833"] = 4876.95115442547,
         ["715144259"] = 4916.403701677634,
         ["430281807"] = 4906.9255206719945,
         ["543966758"] = 4893.46935103102
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 582.6774555742614,
         ["886885833"] = 560.5567956588385,
         ["715144259"] = 580.4544747813864,
         ["430281807"] = 551.1489237495508,
         ["543966758"] = 537.4197582884125
      },

      ["1024"] = {
         ["670828913"] = 876.2202873624468,
         ["886885833"] = 952.4034872604511,
         ["715144259"] = 855.3078214787854,
         ["430281807"] = 896.3168710638333,
         ["543966758"] = 848.3566384930716
      },

      ["10000"] = {
         ["670828913"] = 1499.5305429880395,
         ["886885833"] = 1572.2998256251947,
         ["715144259"] = 1519.5670610497064,
         ["430281807"] = 1367.7344147349233,
         ["543966758"] = 1652.332833395173
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 554.5022686999889,
         ["886885833"] = 545.7331091989504,
         ["715144259"] = 572.9031946695,
         ["430281807"] = 564.0247149708385,
         ["543966758"] = 579.8234131980428
      },

      ["1024"] = {
         ["670828913"] = 1032.2243152495446,
         ["886885833"] = 1037.9958298132792,
         ["715144259"] = 1003.9839070173052,
         ["430281807"] = 1004.7420815966057,
         ["543966758"] = 1133.7845008012143
      },

      ["10000"] = {
         ["670828913"] = 1826.3006589008828,
         ["886885833"] = 1996.2502671697373,
         ["715144259"] = 1824.593442651194,
         ["430281807"] = 1889.147542100181,
         ["543966758"] = 2006.4583091001243
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 2772.2106919129396,
         ["886885833"] = 2724.5257809184677,
         ["715144259"] = 2756.3356476142812,
         ["430281807"] = 2748.1566923026476,
         ["543966758"] = 2779.04589679028
      },

      ["1024"] = {
         ["670828913"] = 2805.552132193714,
         ["886885833"] = 2803.792233848222,
         ["715144259"] = 2795.573233042211,
         ["430281807"] = 2815.9517852591866,
         ["543966758"] = 2794.6771521426112
      },

      ["10000"] = {
         ["670828913"] = 2802.083265481851,
         ["886885833"] = 2811.77113154355,
         ["715144259"] = 2825.7359449960823,
         ["430281807"] = 2756.1069005104546,
         ["543966758"] = 2706.1212644455422
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 550.7140276106774,
         ["886885833"] = 535.458651607697,
         ["715144259"] = 612.8396106679197,
         ["430281807"] = 553.0830696547904,
         ["543966758"] = 580.6984444724569
      },

      ["1024"] = {
         ["670828913"] = 782.4683884364526,
         ["886885833"] = 879.6264391760037,
         ["715144259"] = 786.8888162331981,
         ["430281807"] = 904.0549667982974,
         ["543966758"] = 820.8739635438827
      },

      ["10000"] = {
         ["670828913"] = 1476.2241869449965,
         ["886885833"] = 1478.9731703971106,
         ["715144259"] = 1367.6300128193593,
         ["430281807"] = 1273.725625332252,
         ["543966758"] = 1450.6337411794104
      }
   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 564.593723866608,
         ["886885833"] = 554.6734462672375,
         ["715144259"] = 581.1370968653778,
         ["430281807"] = 557.2183659683001,
         ["543966758"] = 556.6771487079358
      },

      ["1024"] = {
         ["670828913"] = 922.698114584739,
         ["886885833"] = 997.1573758527486,
         ["715144259"] = 908.9238977624005,
         ["430281807"] = 973.0690906784739,
         ["543966758"] = 925.0001105993861
      },

      ["10000"] = {
         ["670828913"] = 1666.011858738589,
         ["886885833"] = 1688.5008118331127,
         ["715144259"] = 1720.5473185085582,
         ["430281807"] = 1672.0463434867966,
         ["543966758"] = 1780.4545175362796
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 541.951185848491,
         ["886885833"] = 517.3459821793044,
         ["715144259"] = 536.7010198409123,
         ["430281807"] = 545.0854623391202,
         ["543966758"] = 553.5834128405542
      },

      ["1024"] = {
         ["670828913"] = 714.5443716535353,
         ["886885833"] = 741.41345645569,
         ["715144259"] = 697.4057628513272,
         ["430281807"] = 706.6759588374641,
         ["543966758"] = 749.686265686291
      },

      ["10000"] = {
         ["670828913"] = 1335.620197987517,
         ["886885833"] = 1344.6115064058076,
         ["715144259"] = 1401.394798932789,
         ["430281807"] = 1254.4225898657005,
         ["543966758"] = 1252.6829667965153
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 519.8197046540845,
         ["886885833"] = 534.1636349292926,
         ["715144259"] = 550.6770954438699,
         ["430281807"] = 531.5784706363123,
         ["543966758"] = 523.6181377733267
      },

      ["1024"] = {
         ["670828913"] = 671.7293573090344,
         ["886885833"] = 657.7099982590238,
         ["715144259"] = 680.5452034355648,
         ["430281807"] = 620.7596657591015,
         ["543966758"] = 636.2719165648614
      },

      ["10000"] = {
         ["670828913"] = 1139.8729562636304,
         ["886885833"] = 1116.4320145045374,
         ["715144259"] = 1165.2307345080044,
         ["430281807"] = 1142.3223426273785,
         ["543966758"] = 1106.797512388579
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 4928.718123622824,
         ["886885833"] = 4935.849135819075,
         ["715144259"] = 4950.525140083778,
         ["430281807"] = 4938.256716964666,
         ["543966758"] = 4927.752695934388
      },

      ["1024"] = {
         ["670828913"] = 4911.932090297552,
         ["886885833"] = 4930.3987381217785,
         ["715144259"] = 4944.736067300632,
         ["430281807"] = 4917.886796977965,
         ["543966758"] = 4935.638417099742
      },

      ["10000"] = {
         ["670828913"] = 4883.151465516628,
         ["886885833"] = 4908.78097463274,
         ["715144259"] = 4889.388655984037,
         ["430281807"] = 4874.484835492509,
         ["543966758"] = 4899.750735931146
      }
   },

   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 589.5605964903026,
         ["886885833"] = 593.8546344178661,
         ["715144259"] = 579.4713953423369,
         ["430281807"] = 601.3667273200032,
         ["543966758"] = 636.8559118978851
      },

      ["1024"] = {
         ["670828913"] = 955.1079659839552,
         ["886885833"] = 1029.4781003019114,
         ["715144259"] = 948.0295277294431,
         ["430281807"] = 974.3098945502416,
         ["543966758"] = 1044.4541823003865
      },

      ["10000"] = {
         ["670828913"] = 1898.5960689439592,
         ["886885833"] = 2128.3165944351717,
         ["715144259"] = 2039.421049083541,
         ["430281807"] = 1973.6289806264276,
         ["543966758"] = 2088.13148690734
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 3346.4722732757223,
         ["886885833"] = 4445.035888114359,
         ["715144259"] = 3250.109090359455,
         ["430281807"] = 3244.43649565519,
         ["543966758"] = 2613.293881583301
      },

      ["1024"] = {
         ["670828913"] = 4316.425592836741,
         ["886885833"] = 3599.723505882737,
         ["715144259"] = 3490.3310675054554,
         ["430281807"] = 4042.552287531049,
         ["543966758"] = 3372.1610850463294
      },

      ["10000"] = {
         ["670828913"] = 7612.707564210958,
         ["886885833"] = 7653.148709717966,
         ["715144259"] = 8896.760937375051,
         ["430281807"] = 7692.30132857857,
         ["543966758"] = 7053.4617266702635
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 3406.2735771002294,
         ["886885833"] = 4178.39123114795,
         ["715144259"] = 2322.8554404565666,
         ["430281807"] = 3587.7629369836054,
         ["543966758"] = 4331.324939497957
      },

      ["1024"] = {
         ["670828913"] = 5326.706152469822,
         ["886885833"] = 4732.7350632680555,
         ["715144259"] = 4756.22086550262,
         ["430281807"] = 4219.923828567336,
         ["543966758"] = 6639.756755135701
      },

      ["10000"] = {
         ["670828913"] = 10797.093960022647,
         ["886885833"] = 10306.887541852755,
         ["715144259"] = 10812.053097307446,
         ["430281807"] = 9562.18274254473,
         ["543966758"] = 8868.601258333456
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 3363.0356764526514,
         ["886885833"] = 2704.555702214051,
         ["715144259"] = 2826.406017305864,
         ["430281807"] = 2587.1621337755782,
         ["543966758"] = 2999.3220134120784
      },

      ["1024"] = {
         ["670828913"] = 4289.917618312783,
         ["886885833"] = 3286.176755981659,
         ["715144259"] = 3231.3207880157347,
         ["430281807"] = 3079.7957616664467,
         ["543966758"] = 2520.895894434859
      },

      ["10000"] = {
         ["670828913"] = 5339.752526963655,
         ["886885833"] = 5264.339605121054,
         ["715144259"] = 5074.263946320385,
         ["430281807"] = 5024.901188302099,
         ["543966758"] = 5660.797812534379
      }
   },

   ["model_LMC"] = {
      ["100"] = {
         ["670828913"] = 668.252497941163,
         ["886885833"] = 670.3536346866413,
         ["715144259"] = 642.9355125576766,
         ["430281807"] = 620.335337248415,
         ["543966758"] = 618.828054018973
      },

      ["1024"] = {
         ["670828913"] = 1348.315854491724,
         ["886885833"] = 1482.762235401472,
         ["715144259"] = 1433.638544073182,
         ["430281807"] = 1450.319579711064,
         ["543966758"] = 1385.356074686716
      },

      ["10000"] = {
         ["670828913"] = 2927.1937523492143,
         ["886885833"] = 2915.0552006409994,
         ["715144259"] = 2825.1558583702727,
         ["430281807"] = 2776.830691576461,
         ["543966758"] = 2566.6459551968533
      }
   },

   ["model_bar"] = {
      ["100"] = {
         ["670828913"] = 531.1594022522904,
         ["886885833"] = 573.2525263780119,
         ["715144259"] = 599.0421779581673,
         ["430281807"] = 591.839962479641,
         ["543966758"] = 572.1817834516663
      },

      ["1024"] = {
         ["670828913"] = 603.823494465777,
         ["886885833"] = 625.1973334777434,
         ["715144259"] = 686.1668839716203,
         ["430281807"] = 576.2884914979807,
         ["543966758"] = 758.4518661477609
      },

      ["10000"] = {
         ["670828913"] = 328.33477553752437,
         ["886885833"] = 383.70540491232725,
         ["715144259"] = 699.4080026214655,
         ["430281807"] = 364.3266933934177,
         ["543966758"] = 470.21654935899414
      }
   },

   ["model_LMC_bar"] = {
      ["100"] = {
         ["670828913"] = 697.1911448768869,
         ["886885833"] = 653.9021277756138,
         ["715144259"] = 636.5274618206518,
         ["430281807"] = 614.7361460399168,
         ["543966758"] = 626.8383777926992
      },

      ["1024"] = {
         ["670828913"] = 1331.2336601389684,
         ["886885833"] = 1458.3110986990978,
         ["715144259"] = 1394.84586999962,
         ["430281807"] = 1434.5188805452688,
         ["543966758"] = 1403.5993672926554
      },

      ["10000"] = {
         ["670828913"] = 2922.0116876096254,
         ["886885833"] = 2863.7451691011756,
         ["715144259"] = 2750.277913080043,
         ["430281807"] = 2803.9308386789653,
         ["543966758"] = 2554.51022283917
      }
   }
}

function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end
